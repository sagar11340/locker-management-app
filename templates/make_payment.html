{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3>Make Payment for {{ doc.full_name if doc and doc.full_name else 'Locker ' ~ (doc.locker_no if doc else '') }}</h3>
      <div class="small-muted">Locker {{ doc.locker_no if doc else '' }}</div>
    </div>
    <div class="text-end small-muted">
      {% if doc and doc.membership_id %}<div>Member ID: {{ doc.membership_id }}</div>{% endif %}
      {% if doc and doc.mobile %}<div>Mobile: {{ doc.mobile }}</div>{% endif %}
    </div>
  </div>

  <!-- SINGLE form: all fields MUST be inside this form -->
  <form method="POST" id="paymentForm" novalidate>
    <div class="card shadow-sm mb-3">
      <div class="card-body">

        <div class="mb-3">
          <label for="payment_date" class="form-label">Payment Date</label>
          <input type="date" id="payment_date" name="payment_date" class="form-control"
                 value="{{ (today.strftime('%Y-%m-%d') if today is defined and today else '') }}" required>
        </div>

        <div class="mb-3">
          <label for="monthly_fee_override" class="form-label">Monthly Fee (default ₹200)</label>
          <input type="text" id="monthly_fee_override" name="monthly_fee_override" class="form-control"
                 placeholder="Leave blank to use default ₹200"
                 value="{{ request.form.get('monthly_fee_override','') }}">
          <div class="form-text">Enter a different fee or 0 to charge nothing. Leave blank to use default ₹200.</div>
        </div>

        <!-- NEW: Months selector and calculated amount -->
        <div class="mb-3">
          <label for="months" class="form-label">Months</label>
          <select id="months" name="months" class="form-select" required>
            <!-- common options; you can change/add more -->
            <option value="1" {% if request.form.get('months') == '1' %}selected{% endif %}>1 month</option>
            <option value="2" {% if request.form.get('months') == '2' %}selected{% endif %}>2 months</option>
            <option value="3" {% if request.form.get('months') == '3' %}selected{% endif %}>3 months</option>
            <option value="4" {% if request.form.get('months') == '4' %}selected{% endif %}>4 months</option>
            <option value="6" {% if request.form.get('months') == '6' %}selected{% endif %}>6 months</option>
            <option value="12" {% if request.form.get('months') == '12' %}selected{% endif %}>12 months</option>
          </select>
          <div class="form-text">Choose how many months the student is paying for.</div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="calculated_monthly_fee" class="form-label">Monthly fee used</label>
            <input type="text" id="calculated_monthly_fee" name="calculated_monthly_fee" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label for="total_amount" class="form-label">Total amount (₹)</label>
            <input type="text" id="total_amount" name="total_amount" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label for="key_missing" class="form-label">Key missing?</label>
            <select id="key_missing" name="key_missing" class="form-select">
              <option value="0" {% if request.form.get('key_missing') in (None,'0') %}selected{% endif %}>No</option>
              <option value="1" {% if request.form.get('key_missing') == '1' %}selected{% endif %}>Yes</option>
            </select>
            <div class="small-muted mt-1">Key missing fine: ₹150 (if applicable)</div>
          </div>
        </div>

        <!-- Start / End date calculation (readonly for user, submitted) -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="calculated_start_date" class="form-label">Start Date (calculated)</label>
            <input type="date" id="calculated_start_date" name="calculated_start_date" class="form-control" readonly>
            <div class="form-text">
              {% if doc and doc.end_date %}Existing end date: {{ doc.end_date }}{% endif %}
            </div>
          </div>
          <div class="col-md-6">
            <label for="calculated_end_date" class="form-label">End Date (calculated)</label>
            <input type="date" id="calculated_end_date" name="calculated_end_date" class="form-control" readonly>
          </div>
        </div>

        <!-- CANCEL LOCKER: hidden default + checkbox (INSIDE the form) -->
        <div class="mb-3 form-check">
          <!-- hidden ensures server always receives a value -->
          <input type="hidden" id="cancelHidden" name="cancel" value="0">
          <input class="form-check-input" type="checkbox" id="cancelBox">
          <label class="form-check-label" for="cancelBox"><strong>Cancel locker (No renewal)</strong></label>
          <div class="form-text">If checked, monthly fee will be treated as ₹0 and the locker will be cancelled (no extension).</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Charge late fine?</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="charge_late" id="charge_yes" value="1" checked>
              <label class="form-check-label" for="charge_yes">Yes — Charge late fine</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="charge_late" id="charge_no" value="0">
              <label class="form-check-label" for="charge_no">No — Waive late fine</label>
            </div>
          </div>
          <div class="form-text">Choose whether to charge the ₹10/day late fine for this payment.</div>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-success btn-lg">Pay &amp; Generate Receipt</button>
        </div>

      </div>
    </div>
  </form>

  <div class="mt-3">
    <a href="{{ url_for('dashboard') }}" class="btn btn-link">&larr; Back to Dashboard</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const cb = document.getElementById('cancelBox');
  const hidden = document.getElementById('cancelHidden');
  const form = document.getElementById('paymentForm');

  // fields
  const paymentDate = document.getElementById('payment_date');
  const monthsSelect = document.getElementById('months');
  const monthlyOverride = document.getElementById('monthly_fee_override');
  const calculatedMonthlyFee = document.getElementById('calculated_monthly_fee');
  const totalAmount = document.getElementById('total_amount');
  const calcStart = document.getElementById('calculated_start_date');
  const calcEnd = document.getElementById('calculated_end_date');
  const keyMissing = document.getElementById('key_missing');

  // get existing end_date from server-side doc (if provided)
  // doc.end_date must be in YYYY-MM-DD or other parseable format
  let existingEndDateStr = `{{ doc.end_date if doc and doc.end_date else '' }}`.trim();
  // parse to Date object (or null)
  function parseDateYMD(s){
    if(!s) return null;
    // try YYYY-MM-DD
    const parts = s.split('-');
    if(parts.length===3){
      const y = parseInt(parts[0],10);
      const m = parseInt(parts[1],10)-1;
      const d = parseInt(parts[2],10);
      return new Date(Date.UTC(y,m,d));
    }
    const d = new Date(s);
    if(isNaN(d)) return null;
    return d;
  }
  const existingEndDate = parseDateYMD(existingEndDateStr);

  // helpers
  function formatDateInput(d){
    if(!d) return '';
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth()+1).padStart(2,'0');
    const day = String(d.getUTCDate()).padStart(2,'0');
    return `${year}-${month}-${day}`;
  }
  function addMonthsUTC(date, months){
    // keep in UTC; create new date
    const y = date.getUTCFullYear();
    const m = date.getUTCMonth();
    const d = date.getUTCDate();
    const targetMonth = m + months;
    const result = new Date(Date.UTC(y, targetMonth, d));
    // If day overflowed (e.g., Jan 31 + 1 month -> Mar 3), adjust to last day of previous month.
    if(result.getUTCDate() !== d){
      // move to last day of previous month
      result.setUTCDate(0);
    }
    return result;
  }
  function addDaysUTC(date, days){
    const t = date.getTime();
    return new Date(t + days * 24 * 60 * 60 * 1000);
  }

  function getPaymentDate(){
    // return Date object in UTC (from input type=date)
    const val = paymentDate.value;
    return parseDateYMD(val) || null;
  }

  function computeAmountsAndDates(){
    // determine monthly fee to use
    let fee = 200; // default
    const overrideVal = (monthlyOverride && monthlyOverride.value.trim()!=='') ? monthlyOverride.value.trim() : '';
    if(overrideVal !== ''){
      // try parse number
      const num = Number(overrideVal.replace(/[^0-9.-]/g,''));
      if(!isNaN(num)) fee = num;
    }
    // if cancel box is checked -> fee treated as 0 and no extension
    const isCancelled = cb && cb.checked;
    const months = Number(monthsSelect.value) || 1;
    const keyMissingVal = (keyMissing && keyMissing.value==='1') ? 150 : 0;

    const paymentDt = getPaymentDate(); // might be null
    // Determine start date:
    // if existingEndDate present -> start = existingEndDate + 1 day (so renewal starts next day)
    // but only if that date > payment date. Otherwise use payment date.
    let startDate;
    if(existingEndDate){
      const potentialStart = addDaysUTC(existingEndDate, 1);
      if(paymentDt && paymentDt > potentialStart){
        startDate = paymentDt;
      } else {
        startDate = potentialStart;
      }
    } else {
      startDate = paymentDt || null;
    }

    // If cancelled -> amount 0 and no extension: clear dates (or keep start_date as payment date but we won't extend)
    let total = 0;
    let monthlyUsed = 0;
    if(isCancelled){
      monthlyUsed = 0;
      total = 0;
    } else {
      monthlyUsed = fee;
      total = (fee * months) + keyMissingVal;
    }

    // write calculated fields
    calculatedMonthlyFee.value = monthlyUsed.toString();
    totalAmount.value = total.toString();

    if(startDate){
      calcStart.value = formatDateInput(startDate);
      if(isCancelled){
        // when cancelled we might not set an end date; set to empty or same as start
        calcEnd.value = '';
      } else {
        const endDate = addMonthsUTC(startDate, months);
        // end date should be the same day-of-month minus 1 day? In original system, for 1 month start 06/10/2025 end 06/11/2025 (1 month exactly)
        // Using addMonthsUTC above produces the same day next month. That's fine.
        calcEnd.value = formatDateInput(endDate);
      }
    } else {
      calcStart.value = '';
      calcEnd.value = '';
    }
  }

  // wire events
  if (cb && hidden){
    hidden.value = cb.checked ? '1' : '0';
    cb.addEventListener('change', function(){
      hidden.value = cb.checked ? '1' : '0';
      // when cancel toggled, recalc amounts/dates
      computeAmountsAndDates();
    });
  } else {
    console.warn('Cancel box or hidden field not found in DOM.');
  }

  // recalc on change of relevant fields
  [paymentDate, monthsSelect, monthlyOverride, keyMissing].forEach(el=>{
    if(el) el.addEventListener('change', computeAmountsAndDates);
    if(el) el.addEventListener('input', computeAmountsAndDates);
  });

  // initial compute
  computeAmountsAndDates();

  // debug: print form data on submit so you can confirm what's sent
  if(form){
    form.addEventListener('submit', function(e){
      const fd = new FormData(form);
      const obj = {};
      for (const [k,v] of fd.entries()) obj[k]=v;
      console.log('DEBUG FormData ->', obj);
      // allow submit to proceed
    });
  }
});
</script>
{% endblock %}

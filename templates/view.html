{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mt-3">RKM DELHI â€” Locker Management</h2>

  <form method="get" class="row g-2 align-items-end my-3">
    <div class="col-auto">
      <label class="form-label">Name</label>
      <input type="text" name="q" value="{{ request.args.get('q','') }}" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label">Membership ID</label>
      <input type="text" name="membership_id" value="{{ request.args.get('membership_id','') }}" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label">Locker No</label>
      <input type="text" name="locker_no" value="{{ request.args.get('locker_no','') }}" class="form-control">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Search</button>
      <a href="{{ url_for('view_lockers') }}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  {% if docs and docs|length > 0 %}
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>sl</th>
          <th>Name</th>
          <th>Membership ID</th>
          <th>Locker No</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days Left</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in docs %}
        {# Determine availability: if status == 'available' OR membership_id is missing -> treat as available #}
        {% set is_available = (d.status == 'available') or (not d.membership_id) %}
        <tr>
          <td>{{ loop.index }}</td>

          {# If available show '-' for fields so no stale partial data appears #}
          <td>{{ '-' if is_available else (d.full_name or '-') }}</td>
          <td>{{ '-' if is_available else (d.membership_id or '-') }}</td>
          <td>{{ d.locker_no or '-' }}</td>

          <td>{{ (d.start_date if not is_available else None)|dateformat }}</td>

          <td>
            {% if not is_available and d.end_date %}
              <span
                {% if d.days_to_expire is not none and d.days_to_expire <= 25 %}
                  style="color: red; font-weight:700;"
                {% endif %}>
                {{ d.end_date|dateformat }}
              </span>
            {% else %}
              -
            {% endif %}
          </td>

          <td>
            {% if not is_available and d.days_to_expire is not none %}
              {% if d.days_to_expire < 0 %}
                <span class="badge bg-danger">Expired {{ -d.days_to_expire }}d</span>
              {% elif d.days_to_expire <= 25 %}
                <span class="badge bg-warning text-dark">Expiring {{ d.days_to_expire }}d</span>
              {% else %}
                {{ d.days_to_expire }} day(s)
              {% endif %}
            {% else %}
              -
            {% endif %}
          </td>

          <td>
            <span class="badge
              {% if d.status == 'active' %} bg-success
              {% elif d.status == 'cancelled' %} bg-warning text-dark
              {% elif d.status == 'vacated' %} bg-secondary text-white
              {% elif d.status == 'available' %} bg-light text-dark
              {% else %} bg-light text-dark {% endif %}">
              {{ (d.status|default('-'))|capitalize }}
            </span>
          </td>

          <td>
            {# Use string conversion for _id so url_for works with ObjectId #}
            {% set id_str = (d._id|string) if d._id else '' %}

            {% if is_available %}
              {# Show Add/Assign button prefilled with locker_no #}
              <a class="btn btn-sm btn-outline-primary"
                 href="{{ url_for('add_locker') }}?locker_no={{ d.locker_no }}">Assign / Add</a>
            {% else %}
              <a class="btn btn-sm btn-info" href="{{ url_for('make_payment', id=id_str) }}">Pay</a>
              <a class="btn btn-sm btn-primary" href="{{ url_for('edit_locker', id=id_str) }}">Edit</a>
              <a class="btn btn-sm btn-danger" href="{{ url_for('delete_locker', id=id_str) }}" onclick="return confirm('Delete this locker?');">Delete</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-info">No locker records found.</div>
  {% endif %}

</div>
{% endblock %}
